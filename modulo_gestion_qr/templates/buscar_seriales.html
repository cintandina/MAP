{% extends "_base.html" %}
{% block title %}Buscar Seriales{% endblock %}

{% block content %}
<div class="flex justify-center items-center min-h-screen bg-gray-100">
    <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg w-full">
        <!-- T铆tulo -->
        <h1 class="text-3xl font-bold text-green-700 text-center mb-6">Buscar Seriales</h1>

        <!-- Formulario -->
        <form method="POST" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% csrf_token %}
            <!-- Cliente -->
            <div>
                <label for="id_cliente" class="block text-sm font-semibold mb-2">Cliente</label>
                <select id="id_cliente" name="cliente"
                        class="block w-full p-2.5 text-sm rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                        onchange="loadProductos(this.value)">
                    <option value="">Seleccione un cliente</option>
                    {% for cliente in form.fields.cliente.queryset %}
                        <option value="{{ cliente.id }}" {% if form.cliente.value == cliente.id %}selected{% endif %}>
                            {{ cliente.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Producto -->
            <div>
                <label for="id_producto" class="block text-sm font-semibold mb-2">Producto</label>
                <select id="id_producto" name="producto"
                        class="block w-full p-2.5 text-sm rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Seleccione un producto</option>
                </select>
            </div>

            <!-- Bot贸n -->
            <div class="col-span-1 md:col-span-2 flex justify-center mt-4">
                <button type="submit"
                        class="bg-green-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Buscar
                </button>
            </div>
        </form>

        <!-- Bot贸n Exportar CSV -->
        {% if seriales %}
        <form method="POST" action="{% url 'exportar_csv' %}" class="mt-4 text-right">
            {% csrf_token %}
            <input type="hidden" name="cliente" value="{{ form.cliente.value }}">
            <input type="hidden" name="producto" value="{{ form.producto.value }}">
            <button type="submit"
            style="background-color: #f59e0b; color: white; padding: 0.5rem 1.25rem; border-radius: 0.375rem; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 2H8a2 2 0 0 0-2 2v4H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2v-4h2a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2zM8 4h11v10h-2V8a2 2 0 0 0-2-2H8V4zm5 10v4H4V10h2v4h7zM6.9 11.5 8 13.4l1.1-1.9H11l-1.6 2.6L11 17H9.2l-1.1-1.9L7 17H5.4l1.6-2.9L5.4 11.5H6.9z"/>
        </svg>
        Exportar a CSV
    </button>
        </form>
        {% endif %}
        

        <!-- Tabla de Resultados -->
        {% if seriales is not None %}
        <div class="mt-8 w-full overflow-x-auto">
            <table class="w-full table-auto border-collapse text-sm text-left">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-2">
                            Serial
                            <input type="text" placeholder="Filtrar..." onkeyup="filterTable(0, this)"
                                   class="mt-1 w-full p-1 text-xs rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </th>
                        <th class="p-2">Cliente</th>
                        <th class="p-2">Producto</th>
                        <th class="p-2">URL</th>
                        <th class="p-2">
                            Estado
                            <select onchange="filterTableSelect(4, this)" 
                                    class="mt-1 w-full p-1 text-xs rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todos</option>
                                <option value="programado">Programado</option>
                                <option value="en_proceso">En Proceso</option>
                                <option value="despachado">Despachado</option>
                                <option value="distribucion">Distribuci贸n</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </th>
                        <th class="p-2">Fecha de Creaci贸n</th>
                        <th class="p-2">{{ nombres_campos.nombre_campo1 }}</th>
                        <th class="p-2">{{ nombres_campos.nombre_campo2 }}</th>
                        <th class="p-2">{{ nombres_campos.nombre_campo3 }}</th>
                        <th class="p-2">{{ nombres_campos.nombre_campo4 }}</th>
                        <th class="p-2">{{ nombres_campos.nombre_campo5 }}</th>
                    </tr>
                </thead>
                <tbody id="seriales-table">
                    {% for serial in seriales %}
                    <tr class="border-b">
                        <td class="p-2 flex items-center">
                            <span class="serial-text">{{ serial.serial }}</span>
                            <button onclick="copyToClipboard(this)" class="ml-2 p-1 bg-gray-200 hover:bg-gray-300 rounded text-xs">
                                
                            </button>
                        </td>
                        <td class="p-2">{{ serial.cliente.nombre }}</td>
                        <td class="p-2">{{ serial.producto.nombre }}</td>
                        <td class="p-2">
                            <a href="{{ serial.url }}" class="text-blue-600 hover:underline" target="_blank">{{ serial.url }}</a>
                        </td>
                        <td class="p-2">{{ serial.estado }}</td>
                        <td class="p-2">{{ serial.fecha_creacion }}</td>
                        <td class="p-2">{{ serial.campo1 }}</td>
                        <td class="p-2">{{ serial.campo2 }}</td>
                        <td class="p-2">{{ serial.campo3 }}</td>
                        <td class="p-2">{{ serial.campo4 }}</td>
                        <td class="p-2">{{ serial.campo5 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="11" class="text-center py-4 text-red-500 font-semibold">
                            No se encontraron seriales para esta combinaci贸n de cliente y producto.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<!-- Scripts -->
<script>
function loadProductos(clienteId) {
    const productoSelect = document.getElementById('id_producto');
    productoSelect.innerHTML = '<option value="">Cargando productos...</option>'; 

    if (!clienteId) {
        productoSelect.innerHTML = '<option value="">Seleccione un producto</option>';
        return;
    }

    fetch(`/api/productos/${clienteId}/`)
        .then(response => response.json())
        .then(data => {
            productoSelect.innerHTML = '<option value="">Seleccione un producto</option>';
            data.forEach(producto => {
                const option = document.createElement('option');
                option.value = producto.id;
                option.textContent = producto.nombre;
                productoSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error cargando productos:', error);
            productoSelect.innerHTML = '<option value="">Error al cargar productos</option>';
        });
}

function filterTable(columnIndex, inputElement) {
    const filterValue = inputElement.value.toLowerCase();
    const rows = document.querySelectorAll("#seriales-table tr");

    rows.forEach(row => {
        const cell = row.cells[columnIndex];
        if (cell) {
            const text = cell.textContent || cell.innerText;
            row.style.display = text.toLowerCase().includes(filterValue) ? "" : "none";
        }
    });
}

function filterTableSelect(columnIndex, selectElement) {
    const filterValue = selectElement.value.toLowerCase();
    const rows = document.querySelectorAll("#seriales-table tr");

    rows.forEach(row => {
        const cell = row.cells[columnIndex];
        if (cell) {
            const text = cell.textContent || cell.innerText;
            row.style.display = filterValue === "" || text.toLowerCase() === filterValue ? "" : "none";
        }
    });
}

function copyToClipboard(button) {
    const serialText = button.previousElementSibling.innerText;
    navigator.clipboard.writeText(serialText).then(() => {
        button.innerText = "锔 Copiado!";
        setTimeout(() => { button.innerText = ""; }, 2000);
    }).catch(err => console.error("Error al copiar:", err));
}
</script>
{% endblock %}







