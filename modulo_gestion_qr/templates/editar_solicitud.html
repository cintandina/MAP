{% extends "_base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Editar Solicitud{% endblock %}

{% block content %}

{# ===== Estilos toggle (CSS puro, no depende de Tailwind) ===== #}
<style>
  .toggle-row { display:flex; align-items:center; gap:12px; user-select:none; }
  .visually-hidden {
    position:absolute !important; width:1px !important; height:1px !important;
    padding:0 !important; margin:-1px !important; overflow:hidden !important;
    clip:rect(0, 0, 0, 0) !important; white-space:nowrap !important; border:0 !important;
  }
  .toggle-track {
    position:relative; width:44px; height:24px; background:#D1D5DB;
    border-radius:9999px; transition:background .2s ease; flex-shrink:0;
  }
  .toggle-knob {
    position:absolute; top:3px; left:3px; width:18px; height:18px;
    background:#fff; border-radius:9999px; box-shadow:0 1px 2px rgba(0,0,0,.2);
    transition:transform .2s ease;
  }
  #id_mostrar_boton_entrega:checked + label .toggle-track { background:#16A34A; }
  #id_mostrar_boton_entrega:checked + label .toggle-knob { transform: translateX(20px); }
  #id_mostrar_boton_entrega:focus + label .toggle-track { box-shadow:0 0 0 4px rgba(134,239,172,.6); outline:none; }
  .toggle-text { font-size:.9rem; font-weight:600; color:#374151; line-height:1.5; }
  .toggle-help { font-size:.75rem; color:#6B7280; margin-top:.25rem; }
</style>

<div class="flex justify-center items-center min-h-screen bg-gray-100">
  <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg w-full max-w-3xl">

    <h1 class="text-3xl font-bold text-blue-700 text-center mb-6">
      Editar Solicitud {{ solicitud.codigo }}
    </h1>

    {# --- Mensajes flash (éxito / error) --- #}
    {% if messages %}
      <div class="mb-4">
        {% for message in messages %}
          <div class="{% if message.tags == 'success' %}bg-green-100 border-green-400 text-green-700{% elif message.tags == 'error' %}bg-red-100 border-red-400 text-red-700{% else %}bg-yellow-100 border-yellow-400 text-yellow-700{% endif %} border px-4 py-3 rounded relative">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {# --- Errores del form y del formset --- #}
    {% if form.errors or formset.errors or formset.non_form_errors %}
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4">
        <p>Por favor, corrige los siguientes errores:</p>
        <ul class="list-disc ml-5">
          {% for field in form %}
            {% for error in field.errors %}
              <li><strong>{{ field.label }}:</strong> {{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
          {% for error in formset.non_form_errors %}
            <li>{{ error }}</li>
          {% endfor %}
          {% for f in formset %}
            {% for field in f %}
              {% for error in field.errors %}
                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
              {% endfor %}
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="grid grid-cols-1 gap-6">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <!-- Código + Logo -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-semibold text-gray-700 mb-2 block">Código</label>
          {{ form.codigo|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
        </div>

        <div>
          <label class="text-sm font-semibold text-gray-700 mb-2 block">Logo</label>

          {% if solicitud.logo %}
            <div class="mb-2">
              <img
                src="{{ solicitud.logo.url }}{% if solicitud.fecha_actualizacion %}?v={{ solicitud.fecha_actualizacion|date:'U' }}{% endif %}"
                alt="Logo actual"
                style="max-height:64px; object-fit:contain; border:1px solid #e5e7eb; padding:4px; border-radius:8px;"
              >
            </div>
          {% endif %}

          {{ form.logo }}

          {% if form.logo.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.logo.errors|first }}</p>
          {% else %}
            <p class="text-xs text-gray-500 mt-1">
              Puedes seleccionar una imagen nueva o marcar “Borrar” para quitar el logo.
            </p>
          {% endif %}
        </div>
      </div>

      <!-- Información Interna -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="text-sm font-semibold text-gray-700 mb-2 block">Cajas</label>
          {{ form.cajas|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700 mb-2 block">Rollos</label>
          {{ form.rollos|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700 mb-2 block">Seriales</label>
          {{ form.seriales|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
        </div>
      </div>

      <!-- Información Landing -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-semibold text-gray-700 mb-2 block">Sobre Nosotros</label>
          {{ form.sobre_nosotros|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700 mb-2 block">Razón Social</label>
          {{ form.razon_social|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700 mb-2 block">NIT</label>
          {{ form.nit|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700 mb-2 block">Correo</label>
          {{ form.correo|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700 mb-2 block">Página Web</label>
          {{ form.pagina_web|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700 mb-2 block">Link Adicional</label>
          {{ form.link_adicional|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
        </div>

        <!-- Toggle: Mostrar botón de confirmar entrega (CSS puro) -->
        <div class="col-span-2" style="margin-top: 1.25rem;">
          <input
            id="id_mostrar_boton_entrega"
            name="{{ form.mostrar_boton_entrega.html_name }}"
            type="checkbox"
            class="visually-hidden"
            {% if form.instance.mostrar_boton_entrega %}checked{% endif %}
          >
          <label for="id_mostrar_boton_entrega" class="toggle-row">
            <span class="toggle-track"><span class="toggle-knob"></span></span>
            <span class="toggle-text">{{ form.mostrar_boton_entrega.label }}</span>
          </label>

          {% if form.mostrar_boton_entrega.errors %}
            <p style="color:#ef4444; font-size:.875rem; margin-top:.25rem;">
              {{ form.mostrar_boton_entrega.errors|first }}
            </p>
          {% endif %}
          <p class="toggle-help">Si está activado, la landing mostrará el botón “Confirmar entrega”.</p>
        </div>
      </div>

      <!-- Ubicaciones -->
      {{ formset.management_form }}
      {% for f in formset %}
        {# IMPORTANTE: renderizar campos ocultos (incluye 'id') #}
        {% for hidden in f.hidden_fields %}
          {{ hidden }}
        {% endfor %}

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            {{ f.direccion.label_tag }}
            {{ f.direccion|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
          </div>
          <div>
            {{ f.telefono.label_tag }}
            {{ f.telefono|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
          </div>
          <div>
            {{ f.ciudad.label_tag }}
            {{ f.ciudad|add_class:"w-full border-gray-300 rounded-lg focus:ring-blue-500" }}
          </div>
        </div>
      {% endfor %}

      <div class="flex justify-start">
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow">
          Guardar Cambios
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}


